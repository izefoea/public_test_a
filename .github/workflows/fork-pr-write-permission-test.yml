name: Fork PR write-permission test (pull_request)

on:
  pull_request:

# 显式申请一个写 scope（你可换成 issues: write / contents: write / checks: write 等）
permissions:
  pull-requests: write

jobs:
  pr_write_test:
    runs-on: ubuntu-latest
    steps:
      - name: Show fork context
        run: |
          echo "event=${{ github.event_name }}"
          echo "repo=${{ github.repository }}"
          echo "actor=${{ github.actor }}"
          echo "pr=${{ github.event.pull_request.number }}"
          echo "is_fork=${{ github.event.pull_request.head.repo.fork }}"
          echo "head_repo=${{ github.event.pull_request.head.repo.full_name }}"
          echo "base_repo=${{ github.event.pull_request.base.repo.full_name }}"

      - name: Try a PR write action (create a review comment)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          IS_FORK: ${{ github.event.pull_request.head.repo.fork }}
        run: |
          payload=$(jq -n \
            --arg body "permission test: pull-requests:write (is_fork=${IS_FORK})" \
            --arg event "COMMENT" \
            '{body:$body, event:$event}')

          code=$(curl -sS -o resp.json -w "%{http_code}" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -X POST \
            "https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}/reviews" \
            -d "${payload}")

          echo "HTTP=${code}"
          cat resp.json || true

          # 201=创建review成功；fork PR通常会403并在这里失败
          test "${code}" = "201"
