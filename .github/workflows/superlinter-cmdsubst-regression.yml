name: super-linter cmdsubst regression (no PR)

on:
  workflow_dispatch:

jobs:
  repro:
    runs-on: ubuntu-latest
    steps:
      - name: Build synthetic repo with base+head branches (forces diff path)
        shell: bash
        run: |
          set -euo pipefail

          # Workspace is empty unless you checkout; we create a synthetic git repo here.
          rm -rf ./* ./.git || true

          # Create a bare "origin" so origin/main exists (super-linter often diffs against origin/<DEFAULT_BRANCH>)
          mkdir -p /tmp/origin.git
          git init --bare /tmp/origin.git

          git init -b main
          git config user.email "test@example.com"
          git config user.name "test"
          git remote add origin /tmp/origin.git

          # Base commit on main
          printf "base\n" > README.md
          git add -A
          git commit -qm "base"
          git push -u origin main

          # Feature branch with crafted filename
          git checkout -b feature
          rm -f .CMD_SUBST_RAN

          # Filename must not contain '/' (creation-time). We generate /github/workspace/.CMD_SUBST_RAN at runtime.
          printf "dummy\n" > 'pre$(p=$(printf "\057github\057workspace\057.CMD_SUBST_RAN"); touch "$p").md'

          git add -A
          git commit -qm "add crafted filename"
          git push -u origin feature

          # Stay on feature
          git status --porcelain

      - name: Run super-linter (pinned) in changed-files mode
        uses: super-linter/super-linter/slim@v8.2.1
        env:
          GITHUB_TOKEN: ${{ github.token }}

          # Force "only changed files" behavior (the code path you hit in PRs)
          VALIDATE_ALL_CODEBASE: "false"

          # Ensure the diff base is our synthetic main branch
          DEFAULT_BRANCH: "main"

          # Keep runtime smaller; still ensures the crafted .md is considered.
          VALIDATE_MARKDOWN: "true"

          # Optional: more logs if you need debugging
          LOG_LEVEL: "DEBUG"

      - name: Assert marker not created
        shell: bash
        run: |
          if [ -f ".CMD_SUBST_RAN" ]; then
            echo "::error::[VULNERABLE] marker file created => command substitution executed"
            exit 1
          fi
          echo "[OK] no marker file created"
