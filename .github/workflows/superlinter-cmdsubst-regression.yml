name: super-linter cmdsubst regression (no PR)

on:
  workflow_dispatch:
    inputs:
      action_ref:
        description: "Action ref to test (e.g., v8.2.1, v8, v7, commit SHA)"
        required: true
        default: "v8.2.1"
      validate_markdown:
        description: "Whether to validate markdown (true/false)"
        required: true
        default: "true"
      validate_all_codebase:
        description: "Whether to validate all codebase (true/false). Use false to force changed-files path."
        required: true
        default: "false"
      default_branch:
        description: "Base branch name for diff"
        required: true
        default: "main"
      log_level:
        description: "LOG_LEVEL (DEBUG/INFO/WARN/ERROR)"
        required: true
        default: "DEBUG"

jobs:
  repro:
    runs-on: ubuntu-latest
    steps:
      - name: Build synthetic repo with base+head branches (forces diff path)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf ./* ./.git || true

          mkdir -p /tmp/origin.git
          git init --bare /tmp/origin.git

          git init -b "${{ inputs.default_branch }}"
          git config user.email "test@example.com"
          git config user.name "test"
          git remote add origin /tmp/origin.git

          printf "base\n" > README.md
          git add -A
          git commit -qm "base"
          git push -u origin "${{ inputs.default_branch }}"

          git checkout -b feature
          rm -f .CMD_SUBST_RAN

          # Filename contains literal $(...) but no '/' characters at creation time.
          # At runtime, it builds /github/workspace/.CMD_SUBST_RAN using octal escapes.
          printf "dummy\n" > 'pre$(p=$(printf "\057github\057workspace\057.CMD_SUBST_RAN"); touch "$p").md'

          git add -A
          git commit -qm "add crafted filename"
          git push -u origin feature

          git status --porcelain
          echo "Prepared repo at: $PWD"

      - name: Run super-linter (pinned) in changed-files mode
        uses: ${{ format('super-linter/super-linter/slim@{0}', inputs.action_ref) }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
          VALIDATE_ALL_CODEBASE: ${{ inputs.validate_all_codebase }}
          DEFAULT_BRANCH: ${{ inputs.default_branch }}
          VALIDATE_MARKDOWN: ${{ inputs.validate_markdown }}
          LOG_LEVEL: ${{ inputs.log_level }}

      - name: Assert marker not created
        shell: bash
        run: |
          if [ -f ".CMD_SUBST_RAN" ]; then
            echo "::error::[VULNERABLE] marker file created => command substitution executed"
            exit 1
          fi
          echo "[OK] no marker file created"
